# 1. 简介

Pwn Deploy Tool(PDT)，是一个轻量级的pwn赛题部署工具，可实现赛题容器的统一化与规范化管理。

安装依赖：
```shell
apt install mysql-server
pip install pandas uuid colorama
```

# 2. 命令用法

本工具目前使用命令行的方式进行管理，在未来的更新版本中可能会支持使用GUI进行管理。在本工具中，一个镜像（PdtImage对象）需要被选中之后才能进行配置，如有多个容器对象被选中，则设置时会对这些容器进行批量配置。

你可以使用`python3 pdt.py script xxx.pscp`通过将多行命令写入脚本文件实现多行命令的批量执行。如果需要单独执行一条命令之后退出，可使用`python3 pdt.py command <commands>`完成。如果只执行`python3 pdt.py`，则会打开PDT命令行，你可以逐行输入命令并执行，还能够查看当前各个镜像与容器的状态信息。

## A. new

该命令可用于创建一个新的容器对象，这个容器对象没有进行任何配置，需要后续通过set命令进行配置。

## B. select

该命令可用于选中镜像对象。<font color=yellow>在一个时刻只能选中一个镜像并进行设置</font>。

## C. set

该命令可用于对选中的容器对象进行配置。

子命令：

- image: 设置容器对象所基于的image，本工具会检查这个image是否在本机存在，因此如果需要使用某个image，需要首先进行下载。
- apt: 设置容器对象在创建之后需要下载的软件包，默认情况下，每个容器都会下载xinetd和lib32z1这两个包，用户可根据需要下载其他的软件包。
- basedir: 设置需要部署的文件的根目录，设置根目录的主要目的是确保在部署时解压文件不会产生其他嵌套目录。
- deploy: 设置需要部署的文件，某些题目可能需要部署多个文件到目标容器中，因此这里可以设置多个文件。
- entry: 设置需要提供服务的文件，这个文件是服务端容器直接对外提供服务的文件，需要是可执行文件。
- port: 设置提供服务的端口。

## D. list

该命令可用于列出容器的一些信息。

子命令：

- image: 列出当前创建的所有镜像。-d选项可查看镜像的所有信息，包含基于这些镜像创建的容器。
- apt: 列出当前创建的所有镜像的所有软件包下载列表。
- deploy: 列出当前创建的所有镜像部署的文件列表。
- select: 列出当前选中的镜像。-d选项可查看镜像的所有信息。
- status: 列出当前所有镜像与容器的状态，镜像有未创建和创建两种状态，容器有关闭和开启两种状态。

## E. build

该命令可用于构建一个或多个镜像，这些镜像将可用于指定数量的容器并对外提供服务。

具体而言，该命令会首先进行一些必要检查，之后会将提前设置的文件进行压缩，生成dockerfile与xinetd文件，开始进行构建。

## F. run

该命令可用于运行容器，其后跟一个数字，表示将开启多少个容器。该命令会以选中的镜像为基础创建容器，如果选中了多个镜像，则会让每一个镜像都创建相同数量的容器。

选项：
- `-n/--new <number>`: 创建容器，number为创建的数量，创建完成后会进行初始化，包括初始化flag等。
- `-a/--all`: 启动所有已经创建的容器。
- `--op`: 设置映射到主机的端口号，如果选择运行多个容器，则端口号会顺序分配，如果没有这个选项，则不进行主机端口映射。指定端口的规则如下例所示：
  - run -n 5 --op 20000: 为容器1,2,3,4,5分配20000,20001,20002,20003,20004号端口。
  - <font color=yellow>注意：端口只能为新创建的容器指定，已经创建的容器不能修改端口映射。</font>
- `<number>...`: 启动指定id的容器，如`run 1 3 4 6 7`则是启动5个容器，如果后面指定`--all`，则启动所有容器，如果指定`-n`，则启动已有容器之外还会创建新容器并启动。注意，如果指定了不存在的id，则会报错跳过，不影响其他具有有效id的容器的使用。
- `-f/--flag`: 指定flag，如果不指定，则默认生成uuid作为flag内容。

## G. rm

该命令可用于删除镜像或容器。

子命令：
- `rm image <images>...`: 删除镜像，例：`rm image pwn pwn2`，注意：如果要删除的镜像还存在容器，则删除时会警告是否删除附带的容器，确认后会删除镜像与容器，否则不删除镜像。使用`-y/--yes`选项默认确认，使用`--no`选项默认拒绝，谨慎使用。对于使用脚本执行的多条命令，如果不指定`-y`选项，则默认不删除。
- `rm container <images.<numbers>...> ...`: 删除容器，例：`rm container pwn.1-5,7,9 pwn2.10-100`——表示删除pwn镜像创建的第1-5、7、9这7个容器，删除pwn2镜像创建的91个容器。注意：在删除容器之后，未被删除的容器id会重新排布，并重新按顺序排列。如1-10这10个容器若删除了第1、3个，则原先第2个容器变成第1个，原先第4个容器变成第2个，以此类推。

## H. stop

该命令可用于停止运行容器。

用法：`stop <images.<numbers>...> ...`，该命令后面的格式与`rm container`相同。

# 3. 目录结构

本工具的目录结构如下所示：

```
- pwn_deploy_tool               —— 主工作目录
  - runtime                     —— 保存运行状态的目录
    - deploy_files              —— 部署文件与镜像启动脚本等的保存目录
      - zips                    —— 需要部署的文件的压缩包集合，压缩包名为sha256值
      - <others>                —— 其他所有目录以镜像名命名，其中保存docker构建脚本、Dockerfile、xinetd文件、docker启动时执行的脚本文件
      - config.yaml             —— 保存当前状态下所有镜像与容器的状态等信息
  - templates                   —— 保存Dockerfile、docker构建脚本、xinetd文件与docker启动时执行的脚本文件的模板
  - help.py                     —— 打印帮助文档的py脚本
  - help_doc.json               —— 以json格式保存的帮助文档
  - pdt.py                      —— 工具入口，保存全局管理类的逻辑
  - pdt_object.py               —— 保存用于表示镜像、容器类的逻辑
  - README.md                   —— 本文档
  - util.py                     —— 保存用于输出等使用功能的逻辑
```

